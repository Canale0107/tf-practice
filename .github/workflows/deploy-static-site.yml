# React SPAã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦S3ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€CloudFrontã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
# - devç’°å¢ƒ: PRä½œæˆæ™‚ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œ
# - prodç’°å¢ƒ: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œ
name: Deploy Static Site to S3

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ï¼ˆprodç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
  push:
    branches:
      - main
    paths:
      # frontendé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ™‚ã®ã¿å®Ÿè¡Œ
      - "frontend/**"
      - ".github/workflows/deploy-static-site.yml"
  # PRä½œæˆæ™‚ï¼ˆdevç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
  pull_request:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-static-site.yml"
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆç’°å¢ƒã‚’é¸æŠå¯èƒ½ï¼‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read           # ã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šæ¨©é™
      pull-requests: write     # PRã«ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹æ¨©é™
    steps:
      - uses: actions/checkout@v3

      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ç’°å¢ƒã‚’æ±ºå®šã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
      # - workflow_dispatchï¼ˆæ‰‹å‹•å®Ÿè¡Œï¼‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸç’°å¢ƒ
      # - pull_request: devç’°å¢ƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
      # - push to main: prodç’°å¢ƒï¼ˆæœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ï¼‰
      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      # ç’°å¢ƒã”ã¨ã®S3ãƒã‚±ãƒƒãƒˆåã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
      # ã“ã‚Œã‚‰ã®å€¤ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰æ™‚ã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹
      - name: Set environment variables
        id: set-vars
        run: |
          if [ "${{ steps.set-env.outputs.environment }}" == "prod" ]; then
            echo "bucket_name=note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "domain_name=note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "api_base_url=https://api.note-app.kanare.dev" >> $GITHUB_OUTPUT
          else
            echo "bucket_name=dev.note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "domain_name=dev.note-app.kanare.dev" >> $GITHUB_OUTPUT
            echo "api_base_url=https://api-dev.note-app.kanare.dev" >> $GITHUB_OUTPUT
          fi

      # AWSèªè¨¼æƒ…å ±ã‚’è¨­å®šï¼ˆS3ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨CloudFrontæ“ä½œã«å¿…è¦ï¼‰
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®S3ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      # ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ï¼ˆå…ˆã«Terraformã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
      - name: Check if S3 bucket exists
        run: |
          if ! aws s3 ls "s3://${{ steps.set-vars.outputs.bucket_name }}" > /dev/null 2>&1; then
            echo "âŒ S3ãƒã‚±ãƒƒãƒˆ ${{ steps.set-vars.outputs.bucket_name }} ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            echo "ğŸ’¡ å…ˆã«Terraformã§ ${{ steps.set-env.outputs.environment }} ç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„"
            exit 1
          fi
          echo "âœ… S3ãƒã‚±ãƒƒãƒˆ ${{ steps.set-vars.outputs.bucket_name }} ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"

      # Terraformã®outputsã‹ã‚‰Cognitoè¨­å®šã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      # Terraformã®outputsã‹ã‚‰Cognito User Pool IDã¨Client IDã‚’å–å¾—
      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰ã«å¿…é ˆã®ç’°å¢ƒå¤‰æ•°ï¼ˆCognitoèªè¨¼ã«ä½¿ç”¨ï¼‰
      # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Terraformå¤±æ•—æ™‚ã¯GitHub Secretsã‹ã‚‰å–å¾—
      - name: Get Cognito configuration from Terraform outputs
        id: get-cognito
        run: |
          cd terraform/environments/${{ steps.set-env.outputs.environment }}

          # Terraform init (backendè¨­å®šã‚’èª­ã¿è¾¼ã‚€ãŸã‚)
          echo "Initializing Terraform..."
          if terraform init > /dev/null 2>&1; then
            echo "âœ… Terraform initialized successfully"

            # Terraform outputsã‹ã‚‰å€¤ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’å®Œå…¨ã«ç„¡è¦–ï¼‰
            USER_POOL_ID=$(terraform output -raw cognito_user_pool_id 2>&1 | grep -v "â•·" | grep -v "â”‚" | grep -v "â•µ" | head -n1 || echo "")
            USER_POOL_CLIENT_ID=$(terraform output -raw cognito_user_pool_client_id 2>&1 | grep -v "â•·" | grep -v "â”‚" | grep -v "â•µ" | head -n1 || echo "")

            # å‡ºåŠ›å€¤ã®æ¤œè¨¼ï¼ˆAWS User Pool IDã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼‰
            if [[ "$USER_POOL_ID" =~ ^[a-z]+-[a-z]+-[0-9]+_[a-zA-Z0-9]+$ ]] && [[ "$USER_POOL_CLIENT_ID" =~ ^[a-zA-Z0-9]+$ ]]; then
              echo "âœ… Terraform outputsã‹ã‚‰Cognitoè¨­å®šã‚’å–å¾—ã—ã¾ã—ãŸ"
              echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT
              echo "user_pool_client_id=$USER_POOL_CLIENT_ID" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Terraform outputs validation failed. Using Secrets..."
              USER_POOL_ID=""
              USER_POOL_CLIENT_ID=""
            fi
          else
            echo "âš ï¸ Terraform init failed. Using Secrets..."
            USER_POOL_ID=""
            USER_POOL_CLIENT_ID=""
          fi

          # Secretsã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          if [ -z "$USER_POOL_ID" ] || [ -z "$USER_POOL_CLIENT_ID" ]; then
            if [ "${{ steps.set-env.outputs.environment }}" == "prod" ]; then
              echo "user_pool_id=${{ secrets.VITE_USER_POOL_ID }}" >> $GITHUB_OUTPUT
              echo "user_pool_client_id=${{ secrets.VITE_USER_POOL_CLIENT_ID }}" >> $GITHUB_OUTPUT
            else
              echo "user_pool_id=${{ secrets.VITE_USER_POOL_ID_DEV }}" >> $GITHUB_OUTPUT
              echo "user_pool_client_id=${{ secrets.VITE_USER_POOL_CLIENT_ID_DEV }}" >> $GITHUB_OUTPUT
            fi
          fi

      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®npmä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # npm ci: package-lock.jsonã‹ã‚‰å†ç¾æ€§ã®é«˜ã„ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      # React SPAã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆproductionæœ€é©åŒ–ï¼‰
      # ç’°å¢ƒå¤‰æ•°ã«API URLã€AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã€Cognitoè¨­å®šã‚’æ³¨å…¥
      - name: Build static site
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_BASE_URL: ${{ steps.set-vars.outputs.api_base_url }}
          VITE_AWS_REGION: ap-northeast-1
          VITE_USER_POOL_ID: ${{ steps.get-cognito.outputs.user_pool_id }}
          VITE_USER_POOL_CLIENT_ID: ${{ steps.get-cognito.outputs.user_pool_client_id }}

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆfrontend/dist/ï¼‰ã‚’S3ãƒã‚±ãƒƒãƒˆã«åŒæœŸ
      # --delete: S3å´ã®å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦å®Œå…¨åŒæœŸ
      - name: Sync static files to S3
        run: |
          aws s3 sync frontend/dist/ s3://${{ steps.set-vars.outputs.bucket_name }}/ --delete
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: https://${{ steps.set-vars.outputs.domain_name }}"

      # ç’°å¢ƒã«å¯¾å¿œã™ã‚‹CloudFront Distributionã®IDã‚’å–å¾—
      # ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆAliasesï¼‰ã‹ã‚‰è©²å½“ã™ã‚‹Distributionã‚’æ¤œç´¢
      - name: Get CloudFront distribution ID
        id: get-cloudfront
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Aliases.Items[?contains(@, '${{ steps.set-vars.outputs.domain_name }}')]].Id | [0]" \
            --output text)

          if [ "$DISTRIBUTION_ID" != "None" ] && [ -n "$DISTRIBUTION_ID" ]; then
            echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
            echo "âœ… CloudFront Distribution ID: $DISTRIBUTION_ID"
          else
            echo "âš ï¸ CloudFront distributionãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "distribution_id=" >> $GITHUB_OUTPUT
          fi

      # CloudFrontã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆæœ€æ–°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã™ãã«é…ä¿¡ï¼‰
      # S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã ã‘ã§ã¯CloudFrontã¯å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿”ã™ãŸã‚å¿…é ˆ
      - name: Invalidate CloudFront cache
        if: steps.get-cloudfront.outputs.distribution_id != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.get-cloudfront.outputs.distribution_id }} \
            --paths "/*"
          echo "âœ… CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ"

      # PRä½œæˆæ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§é€šçŸ¥
      # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã¨ç’°å¢ƒè©³ç´°ã‚’è¡¨ç¤ºã—ã¦ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒç¢ºèªã—ã‚„ã™ãã™ã‚‹
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `### ğŸš€ Static Site Deployed to **${{ steps.set-env.outputs.environment }}** environment

            **Preview URL**: https://${{ steps.set-vars.outputs.domain_name }}

            **Environment Details**:
            - S3 Bucket: \`${{ steps.set-vars.outputs.bucket_name }}\`
            - API URL: \`${{ steps.set-vars.outputs.api_base_url }}\`
            - CloudFront: ${steps.get-cloudfront.outputs.distribution_id ? 'âœ… Cache invalidated' : 'âš ï¸ No distribution found'}

            *Deployed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
